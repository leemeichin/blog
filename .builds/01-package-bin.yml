image: debian/buster
sources:
  - https://git.sr.ht/~mrlee/www.kamelasa.dev
packages:
  - haskell-stack
  - ruby
  - ruby-dev
  - libffi-dev
secrets:
  - f74304b4-9735-47a4-9d23-6d9fd7c47f1a
tasks:
  - publish: |
      cd www.kamelasa.dev
      if git log -1 --name-only --oneline | grep VERSION; then
        sudo gem install fpm
        sudo stack upgrade
        stack setup
        stack build
        fpm -s dir -t deb -n kamelasa -v $(cat VERSION) $(stack path --local-install-root)/kamelasa
        scp kamelasa_$(cat VERSION)_x86_64.deb deploy@kamelasa.mrlee.dev:/var/www/pkg.kamelasa.dev/
      fi
